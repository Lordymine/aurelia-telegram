# Story 4.2: Advanced Formatting & UX

## Status

**Ready for Review**

## Story

**As a** Telegram user,
**I want** well-formatted responses and interactive controls,
**so that** the experience is pleasant and efficient.

## Acceptance Criteria

1. Inline keyboards para: aprovações, seleção de agentes, opções de retry
2. Code blocks com syntax highlighting (markdown do Telegram)
3. Message splitting inteligente: quebra em parágrafos, não no meio de código
4. Envio de arquivos pequenos (specs, stories) como documentos Telegram
5. Typing indicator enquanto processa
6. Rate limiting por usuário (configurable, default 30 msg/min)
7. Testes unitários

## Tasks / Subtasks

- [x] Task 1: Message formatter with code blocks and smart splitting (AC: 2-3)
- [x] Task 2: Inline keyboard helpers (AC: 1)
- [x] Task 3: Rate limiter middleware (AC: 6)
- [x] Task 4: Typing indicator and file sending utilities (AC: 4-5)
- [x] Task 5: Write unit tests (AC: 7)
- [x] Task 6: Validation

## Dev Agent Record

### File List

| File | Action | Description |
|------|--------|-------------|
| `src/bot/utils/formatter.ts` | Created | splitMessage, codeBlock, escapeMarkdownV2, formatADEOutput |
| `src/bot/utils/keyboards.ts` | Created | Inline keyboard helpers (approval, agent, retry, confirm) + parseCallbackData |
| `src/bot/utils/telegram.ts` | Created | startTypingIndicator, sendFileAsDocument, sendLongMessage |
| `src/bot/middleware/rate-limit.ts` | Created | Per-user rate limiting middleware (default 30 msg/min) |
| `src/bot/index.ts` | Modified | Added rate limit middleware, RateLimitOptions in CreateBotOptions |
| `src/index.ts` | Modified | Added exports for formatter, keyboards, telegram utils, rate-limit |
| `tests/unit/bot/formatter.test.ts` | Created | 14 tests for message splitting and formatting |
| `tests/unit/bot/keyboards.test.ts` | Created | 7 tests for inline keyboard helpers |
| `tests/unit/bot/rate-limit.test.ts` | Created | 6 tests for rate limiting middleware |
| `tests/unit/bot/telegram-utils.test.ts` | Created | 7 tests for typing indicator, file sending, long messages |
| `tests/unit/session/manager.test.ts` | Modified | Removed unused vi import |

### Completion Notes

- Smart message splitting: paragraph > newline > sentence > space > hard split (never splits in bottom 30% of chunk)
- Rate limiter uses sliding window buckets per user, auto-cleanup of old buckets
- Typing indicator auto-repeats every 4s (Telegram typing expires after ~5s)
- File sending fallback: if replyWithDocument fails, sends as text
- All 224 tests pass across 23 test files
- Build succeeds cleanly

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-05 | 0.1 | Story draft | River (SM) |
| 2026-02-05 | 0.2 | Implementation complete | Dex (Dev) |
