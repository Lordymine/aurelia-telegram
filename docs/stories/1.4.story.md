# Story 1.4: Telegram Bot Core

## Status

**Ready for Review**

## Story

**As a** developer,
**I want** the Telegram bot running and responding to messages,
**so that** I have the communication channel established.

## Acceptance Criteria

1. Bot Telegram usando grammY com long polling (default) e opção webhook
2. Middleware de autorização: verifica telegram_id contra whitelist de config
3. Mensagem de rejeição para usuários não autorizados
4. Comando `/start` com mensagem de boas-vindas e instruções
5. Comando `/help` com lista de capacidades
6. Comando `/status` com estado atual do bot e conexões
7. Echo handler temporário: repete a mensagem do usuário (placeholder para Kimi)
8. Graceful shutdown (SIGINT/SIGTERM)
9. Logging estruturado com pino (info, debug, error)
10. Testes unitários com mocks do grammY

## CodeRabbit Integration

> **CodeRabbit Integration**: Disabled
>
> CodeRabbit CLI is not enabled in `core-config.yaml`.
> Quality validation will use manual review process only.
> To enable, set `coderabbit_integration.enabled: true` in core-config.yaml

## Tasks / Subtasks

- [x] Task 1: Create auth middleware (AC: 2, 3)
  - [x] 1.1 Create `src/bot/middleware/auth.ts` exporting `createAuthMiddleware(config: AureliaConfig)` that returns a grammY middleware
  - [x] 1.2 Middleware checks `ctx.from.id` against `config.allowedUsers` array
  - [x] 1.3 If user NOT in whitelist: reply with generic "Unauthorized" message and stop propagation
  - [x] 1.4 If user IS authorized: call `next()` to pass to next middleware/handler
  - [x] 1.5 Log unauthorized attempts with pino (userId only, no PII)

- [x] Task 2: Create command handlers (AC: 4, 5, 6)
  - [x] 2.1 Create `src/bot/handlers/commands.ts` exporting handler functions
  - [x] 2.2 Implement `/start` handler: welcome message with bot name, project path, instructions on how to use (mention `/help`, future Kimi integration)
  - [x] 2.3 Implement `/help` handler: list available commands (`/start`, `/help`, `/status`) and briefly describe future capabilities (Kimi translation, ADE execution)
  - [x] 2.4 Implement `/status` handler: show bot uptime (process.uptime()), deploy mode, project path, Kimi auth status (placeholder "not configured"), number of allowed users

- [x] Task 3: Create echo message handler (AC: 7)
  - [x] 3.1 Create `src/bot/handlers/messages.ts` exporting message handler function
  - [x] 3.2 Implement echo handler: for any text message from authorized user, reply with `Echo: {message}` (placeholder for future Kimi translation)
  - [x] 3.3 Log incoming messages with pino (userId, message length — never log message content)

- [x] Task 4: Update bot factory with middleware and handlers (AC: 1, 8, 9)
  - [x] 4.1 Update `src/bot/index.ts` `createBot(config)` to register auth middleware first in the chain
  - [x] 4.2 Register command handlers: `/start`, `/help`, `/status`
  - [x] 4.3 Register echo message handler for `message:text` after commands
  - [x] 4.4 Add `bot.catch()` error handler that logs errors with pino and sends generic error message to user
  - [x] 4.5 Ensure graceful shutdown already works (bot.stop() already called by start.ts on SIGINT/SIGTERM from Story 1.3)

- [x] Task 5: Enhance logger configuration (AC: 9)
  - [x] 5.1 Update `src/utils/logger.ts` to accept configurable log level via environment variable `AURELIA_LOG_LEVEL` (default: 'info')
  - [x] 5.2 Ensure logger supports structured logging with context (userId, chatId, command)

- [x] Task 6: Write unit tests (AC: 10)
  - [x] 6.1 Create `tests/unit/bot/middleware/auth.test.ts` — test auth middleware with authorized/unauthorized users, missing from field, empty whitelist
  - [x] 6.2 Create `tests/unit/bot/handlers/commands.test.ts` — test `/start`, `/help`, `/status` handlers return correct response text
  - [x] 6.3 Create `tests/unit/bot/handlers/messages.test.ts` — test echo handler replies with "Echo: {message}"
  - [x] 6.4 Update `tests/unit/bot/index.test.ts` — test that createBot registers middleware and handlers, test error handler

- [x] Task 7: Validation
  - [x] 7.1 Verify `npm run typecheck` passes
  - [x] 7.2 Verify `npm run lint` passes
  - [x] 7.3 Verify `npm test` passes (all new + existing tests)
  - [x] 7.4 Verify `npm run build` succeeds

## Dev Notes

### Previous Story Insights
[Source: Story 1.3 Dev Agent Record]

- Zod v4 uses `zod/v4` import path (NOT `zod`)
- `loadConfig()` and `saveConfig()` are the main config API from `src/config/manager.ts`
- TypeScript strict mode with `noUncheckedIndexedAccess`
- ESM only — use `import`, never `require`
- `createBot(config)` already returns a real grammY `Bot` instance from Story 1.3
- Start command already handles graceful shutdown (SIGINT/SIGTERM) and calls `bot.stop()`
- Logger (`src/utils/logger.ts`) exists with basic pino setup

### Bot Layer Architecture
[Source: docs/architecture.md#Components — Bot Layer]

- **Middleware chain:** `authMiddleware → rateLimitMiddleware → sessionMiddleware → routerMiddleware`
- For Story 1.4, only **authMiddleware** is needed. Rate limit, session, and router middlewares are for later epics.
- Command handlers: `/start`, `/help`, `/status` (this story), `/auth`, `/auth-status`, `/jobs`, `/cancel` (later stories)
- Message handler: for now, echo (placeholder). In Story 2.3, this will forward to Kimi translator.

### grammY Middleware Pattern
[Source: grammY docs]

```typescript
import { Middleware } from 'grammy';

// Middleware factory
function createAuthMiddleware(config: AureliaConfig): Middleware {
  return async (ctx, next) => {
    const userId = ctx.from?.id;
    if (!userId || !config.allowedUsers.includes(userId)) {
      await ctx.reply('Unauthorized.');
      return; // stop propagation
    }
    await next(); // pass to next middleware/handler
  };
}
```

### grammY Testing Pattern
[Source: grammY docs + Vitest patterns]

grammY context objects can be mocked for unit testing. Create a minimal mock `Context` with the required fields (`from.id`, `reply`, `message.text`). Use `vi.fn()` for methods like `reply()`.

```typescript
// Mock context for testing
function createMockContext(overrides = {}) {
  return {
    from: { id: 123456789 },
    message: { text: '/start' },
    reply: vi.fn(),
    ...overrides,
  };
}
```

### Security Rules
[Source: docs/architecture.md#Security Architecture]

- Auth middleware checks EVERY message (not just /start)
- Rejection message: generic "Unauthorized" (no info leakage)
- Never log message content — only userId, message length, command name
- Never log tokens or API keys

### Error Handler Pattern
[Source: docs/architecture.md#Error Handling Strategy]

```typescript
bot.catch((err) => {
  logger.error({ err: err.error, userId: err.ctx.from?.id }, 'Bot error');
  err.ctx.reply('An error occurred. Please try again.').catch(() => {});
});
```

### Coding Standards
[Source: docs/architecture.md#Coding Standards]

- Files: kebab-case (`auth.ts`, `commands.ts`)
- Functions: camelCase (`createAuthMiddleware`, `handleStart`)
- Constants: UPPER_SNAKE (`UNAUTHORIZED_MESSAGE`)
- Imports: ESM only (`import`), no CommonJS

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-05 | 0.1 | Initial story draft | River (SM) |
| 2026-02-05 | 0.2 | PO validation: all 10 ACs traced, approved | Pax (PO) |
| 2026-02-05 | 0.3 | Implementation complete: all 7 tasks done, 97 tests passing | Dex (Dev) |

## Dev Agent Record

### Agent Model Used

Claude Opus 4.6 (claude-opus-4-6)

### Debug Log References

No issues encountered during implementation.

### Completion Notes List

- All 10 ACs implemented and verified
- 97 unit tests across 14 test files (20 new: auth 5, commands 9, messages 5, bot-factory 1)
- Auth middleware checks every message, rejects unauthorized with generic "Unauthorized." message
- Command handlers (/start, /help, /status) with structured responses
- /status shows uptime, deploy mode, project path, allowed users count, Kimi status
- Echo handler replies "Echo: {message}" as placeholder for future Kimi translation
- Bot error handler logs with pino and sends generic error message
- Logger enhanced with AURELIA_LOG_LEVEL env var support (default: 'info')
- Never logs message content — only userId, messageLength, command name
- Graceful shutdown already working from Story 1.3 (start.ts SIGINT/SIGTERM → bot.stop())

### File List

| File | Status | Description |
|------|--------|-------------|
| `src/bot/index.ts` | Modified | Bot factory with auth middleware, command handlers, echo handler, error handler |
| `src/bot/middleware/auth.ts` | Created | Auth middleware — checks telegram_id against whitelist |
| `src/bot/handlers/commands.ts` | Created | /start, /help, /status command handlers |
| `src/bot/handlers/messages.ts` | Created | Echo message handler (placeholder for Kimi) |
| `src/utils/logger.ts` | Modified | Added AURELIA_LOG_LEVEL env var support |
| `tests/unit/bot/middleware/auth.test.ts` | Created | 5 tests for auth middleware |
| `tests/unit/bot/handlers/commands.test.ts` | Created | 9 tests for command handlers |
| `tests/unit/bot/handlers/messages.test.ts` | Created | 5 tests for echo handler |
| `tests/unit/bot/index.test.ts` | Modified | Added error handler test (4 total) |

## QA Results

### Review Date: 2026-02-05

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation. Clean separation of concerns with middleware and handlers in their own files. Auth middleware correctly applies to every message with generic rejection. Command handlers provide useful operational information. Echo handler is a clean placeholder for future Kimi integration. All 20 new tests cover the critical paths.

### Compliance Check

- Coding Standards: Pass -- camelCase functions, UPPER_SNAKE constants, ESM imports, kebab-case files
- Project Structure: Pass -- middleware/ and handlers/ directories follow architecture.md
- Testing Strategy: Pass -- 20 new tests with mock contexts, edge cases covered
- Security: Pass -- No PII/tokens logged, generic rejection message, no message content in logs
- All ACs Met: Pass -- all 10 ACs verified with test coverage

### Improvements Checklist

- [x] All ACs implemented and tested (no gaps)
- [x] Security review: no PII/tokens logged, generic rejection, auth on every message
- [x] NFR validation: all 4 categories PASS
- [ ] Log debug message when error reply fails (low priority)
- [ ] Add logging middleware for automatic userId/chatId context enrichment

### Gate Status

Gate: **PASS** (95/100) -> docs/qa/gates/1.4-telegram-bot-core.yml

### Recommended Status

Ready for Done -- all ACs met, all tests passing, no blocking issues found.
