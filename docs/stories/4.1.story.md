# Story 4.1: Multi-user Sessions & Isolation

## Status

**Ready for Review**

## Story

**As a** bot administrator,
**I want** multiple users to use the bot with isolated contexts,
**so that** each developer has their own workspace.

## Acceptance Criteria

1. Session manager `src/session/manager.ts` with isolated context per telegram_id
2. Each session maintains: Kimi auth, projeto ativo, conversation history, jobs ativos
3. SQLite storage for session persistence (optional, default in-memory)
4. Comando `/switch_project {path}` para mudar projeto ativo
5. Comando `/whoami` mostra info do usuário e sessão atual
6. Limpeza automática de sessões inativas (configurable TTL)
7. Testes unitários

## Tasks / Subtasks

- [x] Task 1: Implement SessionManager with in-memory store (AC: 1-2)
- [x] Task 2: Add session TTL and cleanup (AC: 6)
- [x] Task 3: Add /switch_project and /whoami handlers (AC: 4-5)
- [x] Task 4: Write unit tests (AC: 7)
- [x] Task 5: Validation

## Dev Agent Record

### File List

| File | Action | Description |
|------|--------|-------------|
| `src/session/manager.ts` | Modified | Full SessionManager replacing stub — Map-based, TTL cleanup, conversation history |
| `src/bot/handlers/commands.ts` | Modified | Added /switch_project and /whoami command handlers |
| `src/bot/index.ts` | Modified | Added CreateBotOptions interface, wired sessionManager |
| `src/index.ts` | Modified | Added SessionManager, UserSession, SessionManagerOptions exports |
| `tests/unit/session/manager.test.ts` | Created | 18 tests covering all SessionManager methods |

### Completion Notes

- SessionManager uses in-memory Map<number, UserSession> with configurable TTL (default 24h)
- Auto-cleanup interval runs hourly, uses `.unref()` to not block process exit
- `switchProject()` clears conversation history for fresh context
- `addMessage()` trims history when exceeding `maxHistory` (default 50)
- All 190 tests pass across 19 test files
- Build succeeds cleanly

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-05 | 0.1 | Story draft | River (SM) |
| 2026-02-05 | 0.2 | Implementation complete | Dex (Dev) |
